const aquamarine_scroll_end=new Event("aquamarine:scroll_end"),aquamarine={router:{routes:[],connect:function(regex,handler){this.routes.push({regex:new RegExp(regex),handler:handler})},checkRoutes:function(url){for(var matchFound=!1,i=0;i<this.routes.length;i++){var route=this.routes[i],match=url.match(route.regex);if(match){matchFound=!0,route.handler.apply(null,match.slice(1));break}}}},logger:{log_initialize:function(str){console.log(`%c[INIT] ${str}`,"color: #36a8e0")},log_info:function(str){console.log(`%c[INFO] ${str}`,"color: #2ec91c")},log_error:function(str){console.log(`%c[ERROR] ${str}`,"color: #d13017")}},init:{initialize:function(){const logout=document.querySelector("#settings-logout"),settings=document.querySelector("#settings-button");logout&&logout.addEventListener("click",aquamarine.account.logout),settings&&settings.addEventListener("click",this.nav.toggle_settings_menu),this.initialize_href()},initialize_href:function(){document.querySelectorAll("[data-href]").forEach(e=>{e.removeEventListener("click",this.href.href_click),e.addEventListener("click",this.href.href_click)})},initialize_empathies:function(callback){document.querySelectorAll(".empathy:not(.disabled)").forEach(e=>{e.removeEventListener("click",this.empathies.empathy_click)}),document.querySelectorAll(".empathy:not(.disabled)").forEach(e=>{e.addEventListener("click",this.empathies.empathy_click)})},initialize_add_post:function(file_callback){const feeling_inputs=document.querySelectorAll(".feeling-selector input"),file_upload=document.querySelector('input[type="file"]'),textarea=document.querySelector("textarea");textarea&&(document.querySelectorAll("[data-expand]").forEach(e=>{e.addEventListener("click",this.add_post.open_expandable)}),aquamarine.logger.log_initialize("Initializing feeling selector"),feeling_inputs.forEach(e=>{e.addEventListener("click",this.add_post.feeling_selector_click)}),aquamarine.logger.log_initialize("Initializing textarea"),textarea.addEventListener("input",this.add_post.textarea_input),aquamarine.logger.log_initialize("Initializing file upload"),file_upload.addEventListener("change",event=>{this.add_post.file_upload_change(event,file_callback)}))},initialize_favorite_button:function(){aquamarine.logger.log_initialize("Initializing favorites"),document.querySelector("button.favorite-button")&&document.querySelector("button.favorite-button").addEventListener("click",this.favorite.favorite_click)},nav:{toggle_settings_menu:function(event){document.querySelector(".settings-menu").classList.toggle("none")}},add_post:{file_upload_change:function(event,file_callback){const send_button=document.querySelector(".add-new-post button");send_button.setAttribute("disabled","true");var input=event.target;const reader=new FileReader;reader.readAsDataURL(input.files[0]),reader.onload=()=>{screenshot=reader.result.split(",")[1],screenshot_MIME=input.files[0].type,send_button.removeAttribute("disabled"),file_callback(screenshot,screenshot_MIME)}},textarea_input:function(event){const send_button=document.querySelector(".add-new-post button");event.target.value.replace(/\s/g,"").length<=0?send_button.setAttribute("disabled","true"):send_button.removeAttribute("disabled")},feeling_selector_click:function(event){document.querySelectorAll(".feeling-selector input").forEach(feeling=>{feeling.classList.remove("selected")}),event.target.classList.add("selected")},open_expandable:function(event){document.querySelectorAll(event.target.getAttribute("data-expand")).forEach(e=>{e.classList.remove("none")})}},empathies:{empathy_click:function(event){event.stopPropagation(),aquamarine.actions.empathy(event.currentTarget.getAttribute("data-post-id"),callback)}},href:{href_click:function(event){window.location.href=event.currentTarget.getAttribute("data-href")}},favorite:{favorite_click:function(event){aquamarine.actions.favorite(document.querySelector("button.favorite-button").getAttribute("data-community-id"))}}},error:{show_error_by_attr:function(attr,callback){const error_text=document.querySelector("span.error-text");error_text.getAttribute(attr)?(error_text.classList.remove("none"),error_text.classList.add("transition"),error_text.innerHTML=error_text.getAttribute(attr),setTimeout(()=>{error_text.classList.remove("transition"),callback()},2100)):aquamarine.logger.log_error(`Could not find an error locale for ${attr}`)}},account:{login:async function(){const username=document.querySelector('input[name="username"]').value,password=document.querySelector('input[name="password"]').value,signin=document.querySelector('button[data-role="signin"]');if(!username||!password)return;aquamarine.logger.log_info("Logging into new account. WARNING - Please do not send your auth token to ANYONE. No admin will ever ask for it.");const token_data=await fetch("/api/oauth/retrieve_token",{method:"POST",headers:{"auth-password":password,"auth-network-id":username}}),token=await token_data.json();if(0==token.success){switch(signin.setAttribute("disabled",!0),token.error){case"NO_ACCOUNT_FOUND":aquamarine.error.show_error_by_attr("data-no-account",()=>signin.removeAttribute("disabled"));break;case"PASSWORD_MISMATCH":aquamarine.error.show_error_by_attr("data-password-mismatch",()=>signin.removeAttribute("disabled"));break;default:aquamarine.error.show_error_by_attr("data-default",()=>signin.removeAttribute("disabled"))}return}this.update_auth_token(token.token,document.querySelector('input[type="checkbox"]').checked);const redirect=new URLSearchParams(window.location.search).get("redirect");window.location.href=redirect||"/"},logout:function(){aquamarine.logger.log_info("Logging out of current account.");var currentURL=window.location.href;document.cookie="jwt=; Path=/; Secure; SameSite=None; expires=Thu, 01 Jan 1970 00:00:01 GMT;",setTimeout(()=>{window.location.href=currentURL},100)},update_auth_token:function(token,remember){if(remember){var date=new Date;date.setTime(date.getTime()+2592e6),document.cookie=`jwt=${token}; Path=/; Secure; SameSite=None; expires=${date.toUTCString()};`}else document.cookie=`jwt=${token}; Path=/; Secure; SameSite=None`}},actions:{empathy:async function(post_id,callback){const post_yeah_button=document.querySelector(`#post-${post_id} button.empathy`),post_yeah_button_text=document.querySelector(`#post-${post_id} .post-actions .empathy span`),post_empathy_count=document.querySelector(`#post-${post_id} .post-actions span.empathy-count`);post_yeah_button.setAttribute("disabled",!0);const empathy_request=await fetch(`/api/posts/${post_id}/empathy`,{method:"POST"}),empathy_data=await empathy_request.json();if(0!=empathy_data.success){switch(empathy_data.empathy_status){case"CREATED":post_yeah_button_text.innerHTML=post_yeah_button.getAttribute("data-unyeah-text"),post_empathy_count.innerHTML=Number(post_empathy_count.innerHTML)+1;break;case"DELETED":post_yeah_button_text.innerHTML=post_yeah_button.getAttribute("data-yeah-text"),post_empathy_count.innerHTML=Number(post_empathy_count.innerHTML)-1}post_yeah_button.removeAttribute("disabled"),callback&&callback(empathy_data.empathy_status)}else aquamarine.logger.log_error(empathy_data.error)},favorite:async function(community_id){const community_favorite_button=document.querySelector("button.favorite-button"),error_text=document.querySelector(".community-actions span.error-text");community_favorite_button.setAttribute("disabled",!0);const favorite_request=await fetch(`/api/communities/${community_id}/favorite`,{method:"POST"}),favorite_data=await favorite_request.json();if(0!=favorite_data.success)"CREATED"==favorite_data.favorite_status?community_favorite_button.classList.add("selected"):community_favorite_button.classList.remove("selected"),error_text.classList.add("none"),community_favorite_button.removeAttribute("disabled");else{switch(error_text.classList.remove("none"),error_text.classList.add("transition"),favorite_data.error){case"NULL_COMMUNITY":error_text.innerHTML=error_text.getAttribute("data-null-community-id");break;default:error_text.innerHTML=error_text.getAttribute("data-default")}setTimeout(()=>{error_text.classList.remove("transition"),community_favorite_button.removeAttribute("disabled")},2100)}},last_request_status:200,currently_downloading:!1,download_posts:async function(selector,query){const post_list=document.querySelector(selector),loading=document.querySelector(".loading");if(200!==this.last_request_status||this.currently_downloading||0===post_list.children.length||!loading)return;loading.classList.remove("none"),this.currently_downloading=!0;const posts_request=await fetch(query);return new Promise(async(resolve,reject)=>{if(posts_request.ok){const posts_html=await posts_request.text();post_list.innerHTML+=posts_html,aquamarine.initialize_empathies(),aquamarine.initialize_href(),loading.classList.add("none"),this.last_request_status=posts_request.status,this.currently_downloading=!1,resolve(posts_request.status)}else reject(posts_request.status)})}}};document.addEventListener("DOMContentLoaded",()=>{aquamarine.router.checkRoutes(window.location.pathname),aquamarine.init.initialize(),document.addEventListener("scroll",ev=>{Math.ceil(window.scrollY+window.innerHeight+5)>=document.body.scrollHeight&&document.dispatchEvent(aquamarine_scroll_end)})}),aquamarine.router.connect("^/communities/(\\d+)$",community_id=>{const send_button=document.querySelector(".add-new-post button"),textarea=document.querySelector("textarea"),file_upload=document.querySelector('input[type="file"]');var screenshot,screenshot_MIME;async function make_post(){const feeling_id=document.querySelector("input.selected").value,data={body:textarea.value,spoiler:0,owns_title:0,community_id:community_id,feeling_id:feeling_id};screenshot&&(data.screenshot=screenshot,data.screenshot_MIME=screenshot_MIME),send_button.setAttribute("disabled",!0);const request=await fetch("/api/posts",{method:"POST",body:JSON.stringify(data),headers:{"Content-Type":"application/json"}}),request_json=await request.json();if(1==request_json.success){const post_list=document.querySelector("div.list");1==Number(post_list.getAttribute("data-no-posts"))&&(post_list.innerHTML="",post_list.setAttribute("data-no-posts",0)),post_list.innerHTML=request_json.html+post_list.innerHTML,aquamarine.initialize_empathies(),aquamarine.initialize_href(),post_list.children[0].classList.add("transition"),textarea.value="",file_upload.value=null,screenshot=null,screenshot_MIME=null,setTimeout(()=>{post_list.children[0].classList.remove("transition")},2100)}}aquamarine.initialize_add_post((function(screenshot,screenshot_MIME){screenshot=screenshot,screenshot_MIME=screenshot_MIME})),console.log("Initializing post button"),send_button&&send_button.addEventListener("click",make_post),console.log("Initializing empathies"),aquamarine.initialize_empathies(),aquamarine.initialize_favorite_button(),console.log("Initializing downloading");const post_list=document.querySelector(".list");document.addEventListener("aquamarine:scroll_end",async e=>{const offset=post_list.children.length;await aquamarine.actions.download_posts(".list",`?raw=1&offset=${offset}&limit=25`)})}),aquamarine.router.connect("^/search",async()=>{aquamarine.initialize_empathies();const post_list=document.querySelector(".list"),current_query=new URLSearchParams(window.location.search).get("q");document.addEventListener("aquamarine:scroll_end",async e=>{const offset=post_list.children.length;await aquamarine.actions.download_posts(".list",`?q=${current_query}&raw=1&offset=${offset}&limit=25`)})}),aquamarine.router.connect("^/login$",()=>{const signin=document.querySelector('button[data-role="signin"]'),username=document.querySelector('input[name="username"]'),password=document.querySelector('input[name="password"]');signin.addEventListener("click",e=>{signin.setAttribute("disabled",!0),aquamarine.account.login()}),[username,password].forEach(e=>{e.addEventListener("input",a=>{username.value.length>1&&password.value.length>1?signin.removeAttribute("disabled"):signin.setAttribute("disabled",!0)})}),console.log("Initialized Login")}),aquamarine.router.connect("^/signup$",async()=>{const main_password_input=document.querySelector('input[name="password"]'),confirm_password_input=document.getElementById("confirm"),network_id_input=document.querySelector('input[name="username"]'),email_input=document.querySelector('input[name="email"]'),nickname_input=document.querySelector('input[name="nickname"]'),sign_up_button=document.querySelector('input[type="submit"]'),form=document.querySelector("form"),inputs=[main_password_input,confirm_password_input,network_id_input,email_input,nickname_input];await inputs.forEach(e=>{e.addEventListener("input",a=>{main_password_input.value.length>2&&confirm_password_input.value.length>2&&network_id_input.value.length>2&&email_input.value.length>2&&nickname_input.value.length>2&&confirm_password_input.value==main_password_input.value?sign_up_button.removeAttribute("disabled"):sign_up_button.setAttribute("disabled",!0)})}),form.addEventListener("submit",e=>{e.preventDefault(),sign_up_button.setAttribute("disabled",!0),form.submit()})}),aquamarine.router.connect("^/users/([^/]+)$",async user_name=>{aquamarine.initialize_empathies()}),aquamarine.router.connect("^/users/(\\S*)/posts$",async user_name=>{aquamarine.initialize_empathies(),document.addEventListener("aquamarine:scroll_end",async ev=>{const post_list=document.querySelector(".list"),offset=post_list.children.length;await aquamarine.actions.download_posts(".list",`?raw=1&offset=${offset}&limit=25`)})}),aquamarine.router.connect("^/users/(\\S*)/empathies$",async user_name=>{aquamarine.initialize_empathies(),document.addEventListener("aquamarine:scroll_end",async ev=>{const post_list=document.querySelector(".list"),offset=post_list.children.length;await aquamarine.actions.download_posts(".list",`?raw=1&offset=${offset}&limit=25`)})}),aquamarine.router.connect("^/posts/([^/]+)$",async post_id=>{const textarea=document.querySelector("textarea"),file_upload=document.querySelector('input[type="file"]'),send_button=document.querySelector(".add-new-post button");var screenshot,screenshot_MIME;async function make_reply(){const feeling_id=document.querySelector("input.selected").value,data={body:textarea.value,spoiler:0,feeling_id:feeling_id};screenshot&&(data.screenshot=screenshot,data.screenshot_MIME=screenshot_MIME),send_button.setAttribute("disabled",!0);const request=await fetch(`/api/posts/${document.querySelector("[data-post-id]").getAttribute("data-post-id")}/replies`,{method:"POST",body:JSON.stringify(data),headers:{"Content-Type":"application/json"}}),request_json=await request.json();if(1==request_json.success){const reply_list=document.querySelector("div.replies.list");1==Number(reply_list.getAttribute("data-no-replies"))&&(reply_list.innerHTML="",reply_list.setAttribute("data-no-replies",0)),reply_list.innerHTML=request_json.html+reply_list.innerHTML,aquamarine.initialize_empathies(),aquamarine.initialize_href(),reply_list.children[0].classList.add("transition"),textarea.value="",file_upload.value=null,screenshot=null,screenshot_MIME=null;const reply_count=document.querySelector("span.reply-count");reply_count.innerText=Number(reply_count.innerText)+1,setTimeout(()=>{reply_list.children[0].classList.remove("transition")},2100)}}aquamarine.init.initialize_empathies((function(empathy_status){const empathy=document.querySelector(".empathies a[data-self]"),empathies=document.querySelector(".empathies");if(empathy){switch(empathy_status){case"CREATED":empathy.classList.remove("none");break;case"DELETED":empathy.classList.add("none")}empathies.querySelectorAll("a:not(.none)").length>=1?empathies.classList.remove("none"):empathies.classList.add("none")}})),aquamarine.init.initialize_add_post((function(screenshot_c,screenshot_MIME_c){screenshot=screenshot_c,screenshot_MIME=screenshot_MIME_c})),send_button.addEventListener("click",make_reply)}),aquamarine.router.connect(/^\/communities\/\d+\/(\w+)$/,async tab=>{if("hot"!==tab){const post_list=document.querySelector(".list");document.addEventListener("aquamarine:scroll_end",async e=>{const offset=post_list.children.length;await aquamarine.actions.download_posts(".list",`?raw=1&offset=${offset}&limit=25`)})}aquamarine.initialize_favorite_button()});